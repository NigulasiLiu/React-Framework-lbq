import React from 'react';
import { Row, Col, Card, Typography, Button, Input, Select, Form, Modal, message, Alert } from 'antd';
import { DataContext, DataContextType } from '../ContextAPI/DataManager';
import { Link } from 'react-router-dom';
import { ExclamationCircleOutlined, LoadingOutlined } from '@ant-design/icons';
import detailsPage from '../DetailsPage/DetailsPage';

const { Text } = Typography;


interface VulnerabilityDetailsSidebarState {
    showModal: boolean;
    doneVulnerabilitiesCount: number;
    currentRecord: any, // 当前选中的记录

    isSidebarOpen: boolean;

    vulnName: string;
    vulnBugExp: string;
    vulnType: string;
    poc: string;
    finger: string;
    isExp: boolean;

}

// 定义 VulnerabilityDetailsSidebar 组件的 Props 类型
interface VulnerabilityDetailsSidebarProps {
    detailsPage:boolean;
    host_uuid: string;
    //vulnInfoArray:VulnerabilityDetailsItemType;

    isSidebarOpen: boolean;
    toggleSidebar: () => void;
    onDoneButtonClick: (record: any) => Promise<void>;
}

class VulnerabilityDetailsSidebar extends React.Component<VulnerabilityDetailsSidebarProps, VulnerabilityDetailsSidebarState> {
    constructor(props: any) {
        super(props);
        this.state = {

            doneVulnerabilitiesCount: 0,
            currentRecord: null,
            showModal: false,
            vulnName: '',
            vulnBugExp: '',
            vulnType: '',
            poc: '',
            finger: '',
            isExp: false,
            isSidebarOpen: false,
        };
    }

    componentDidMount(): void {
        this.setState({
            vulnName: '名称',
            poc: '危险等级',
            finger: '危险等级',
            isExp: false,

        });
    }

    toggleModal = (record = null) => {
        this.setState(prevState => ({
            showModal: !prevState.showModal,
            currentRecord: record, // 设置当前记录，以便后续操作
        }));
    };


    formItemLayout = {
        labelCol: {
            xs: { span: 24 },
            sm: { span: 6 },
        },
        wrapperCol: {
            xs: { span: 24 },
            sm: { span: 14 },
        },
    };


    renderVulnDetail = (vulnOriginData: any[]) => {
        if (vulnOriginData !== undefined) {
            const ignoredBugExps_array = JSON.parse(localStorage.getItem('ignoredBugExps_array') || '{}');
            const filteredData = vulnOriginData.filter(item => item.uuid === this.props.host_uuid);
            return (
                <div style={{ margin: '0px -16px' }}>
                    {filteredData.length > 0 ? (//ul内置了外边距
                        <ul style={{ width: '100%', padding: 0, margin: 0 }}>
                            {filteredData.map((item, index) => {
                                const expResult = item.vul_detection_exp_result || [];
                                const fingerResult = item.vul_detection_finger_result || [];
                                const pocResult = item.vul_detection_poc_result || [];
                                const noResults = (!expResult || expResult.length === 0) &&
                                    (!fingerResult || fingerResult.length === 0) &&
                                    (!pocResult || pocResult.length === 0);

                                if (noResults) {
                                    return <div key={index}>
                                        <Alert
                                            message="本次扫描未发现漏洞"
                                            description="这是一条扫描记录,未发现漏洞"
                                            type="warning"
                                            showIcon
                                            icon={<ExclamationCircleOutlined style={{ color: '#ffcc00' }} />}
                                            style={{ marginBottom: '20px' }} />
                                    </div>;
                                }
                                // 继续处理显示每个条目的逻辑
                                return (
                                    <Row key={index}>
                                        <Card style={{
                                            width: 800,
                                            minHeight: 800,
                                            borderTop: '1px solid black',
                                            backgroundColor: '#E5E8EF',
                                        }}>
                                            {item.vul_detection_exp_result.map((expResult: {
                                                id: number;
                                                bug_exp: any;
                                            }, subIndex: string | number) => {
                                                const fingerResult = item.vul_detection_finger_result[subIndex] || { finger: '未知' };
                                                const pocResult = item.vul_detection_poc_result[subIndex] || {
                                                    bug_poc: '未知',
                                                    url: '#',
                                                };
                                                const isIgnored = ignoredBugExps_array[this.props.host_uuid]?.includes(expResult.bug_exp);
                                                return (
                                                    <React.Fragment key={`exp-${subIndex}`}>
                                                        <Card style={{
                                                            width: '100%',
                                                            marginTop: '-15px',
                                                            border: '2px solid #becffa',
                                                            opacity: isIgnored ? 0.5 : 1, // 调整透明度
                                                            backgroundColor: isIgnored ? '#f0f0f0' : 'white', // 调整背景颜色
                                                        }}>
                                                            <Row style={{
                                                                borderBottom: '2px solid #E5E8EF',
                                                                paddingBottom: '10px',
                                                            }}>
                                                                <div style={{
                                                                    fontSize: 20,
                                                                    textDecoration: isIgnored ? 'line-through' : 'none',
                                                                }}>
                                                                    {`漏洞名称[${expResult.bug_exp}]`}
                                                                </div>
                                                            </Row>
                                                            <Row>
                                                                <div style={{
                                                                    fontSize: 18,
                                                                    marginTop: '10px',
                                                                    marginBottom: '10px',
                                                                }}>漏洞信息
                                                                </div>
                                                            </Row>
                                                            <Row style={{ width: '100%' }}>
                                                                {/* 漏洞名称、编号等信息 */}
                                                                <Col md={8}
                                                                     style={{
                                                                         fontSize: '16px',
                                                                         marginBottom: '8px',
                                                                         textDecoration: isIgnored ? 'line-through' : 'none',
                                                                     }}>
                                                                    <Row>
                                                                        <Text style={{
                                                                            color: 'grey',
                                                                            marginTop: '3px',
                                                                            marginBottom: '3px',
                                                                        }} strong>漏洞名称</Text>
                                                                    </Row>
                                                                    <Row>
                                                                        <Text style={{
                                                                            marginTop: '3px',
                                                                            marginBottom: '3px',
                                                                        }}>{`漏洞名称[${expResult.bug_exp}]`}</Text>
                                                                    </Row>
                                                                </Col>
                                                                <Col md={8}
                                                                     style={{
                                                                         fontSize: '16px',
                                                                         marginBottom: '8px',
                                                                         textDecoration: isIgnored ? 'line-through' : 'none',
                                                                     }}>
                                                                    <Row>
                                                                        <Text style={{
                                                                            color: 'grey',
                                                                            marginTop: '3px',
                                                                            marginBottom: '3px',
                                                                        }} strong>漏洞编号</Text>
                                                                    </Row>
                                                                    <Row>
                                                                        <Text style={{
                                                                            marginTop: '3px',
                                                                            marginBottom: '3px',
                                                                        }}>{expResult.id}</Text>
                                                                    </Row>
                                                                </Col>
                                                                {/* 指纹信息 */}
                                                                <Col md={8}
                                                                     style={{
                                                                         fontSize: '16px',
                                                                         marginBottom: '8px',
                                                                         textDecoration: isIgnored ? 'line-through' : 'none',
                                                                     }}>
                                                                    <Row>
                                                                        <Text style={{
                                                                            color: 'grey',
                                                                            marginTop: '3px',
                                                                            marginBottom: '3px',
                                                                        }} strong>漏洞类型指纹</Text>
                                                                    </Row>
                                                                    <Row>
                                                                        <Text style={{
                                                                            marginTop: '3px',
                                                                            marginBottom: '3px',
                                                                        }}>{fingerResult ? `漏洞类型指纹[${fingerResult.finger}]` : 'N/A'}</Text>
                                                                    </Row>
                                                                </Col>
                                                                {/* 风险级别 */}
                                                                <Col md={8}
                                                                     style={{
                                                                         fontSize: '16px',
                                                                         marginBottom: '8px',
                                                                         textDecoration: isIgnored ? 'line-through' : 'none',
                                                                     }}>
                                                                    <Row>
                                                                        <Text style={{
                                                                            color: 'grey',
                                                                            marginTop: '3px',
                                                                            marginBottom: '3px',
                                                                        }} strong>风险级别</Text>
                                                                    </Row>
                                                                    <Row>
                                                                        <Text style={{
                                                                            marginTop: '3px',
                                                                            marginBottom: '3px',
                                                                        }}>{pocResult ? `风险级别[${pocResult.bug_poc}]` : 'N/A'}</Text>
                                                                    </Row>
                                                                </Col>
                                                                <Col md={8}
                                                                     style={{
                                                                         fontSize: '16px',
                                                                         marginBottom: '8px',
                                                                         textDecoration: isIgnored ? 'line-through' : 'none',
                                                                     }}>
                                                                    <Row>
                                                                        <Text style={{
                                                                            color: 'grey',
                                                                            marginTop: '3px',
                                                                            marginBottom: '3px',
                                                                        }} strong>是否有exp</Text>
                                                                    </Row>
                                                                    <Row>
                                                                        <Text style={{
                                                                            marginTop: '3px',
                                                                            marginBottom: '3px',
                                                                        }}>{expResult.bug_exp ? '是' : '否'}</Text>
                                                                    </Row>
                                                                </Col>
                                                                <Col md={8}
                                                                     style={{ fontSize: '16px', marginBottom: '8px' }}>
                                                                    <Row>
                                                                        <Text style={{
                                                                            color: 'grey',
                                                                            marginTop: '3px',
                                                                            marginBottom: '3px',
                                                                        }} strong>扫描端口</Text>
                                                                    </Row>
                                                                    <Row>
                                                                        <Text style={{
                                                                            marginTop: '3px',
                                                                            marginBottom: '3px',
                                                                        }}>{item.port}</Text>
                                                                    </Row>
                                                                </Col>
                                                            </Row>
                                                            <Row style={{ width: '100%' }}>
                                                                <Col md={24}
                                                                     style={{
                                                                         fontSize: '16px',
                                                                         marginBottom: '8px',
                                                                         textDecoration: isIgnored ? 'line-through' : 'none',
                                                                     }}>
                                                                    <Row>
                                                                        <Text style={{
                                                                            color: 'grey',
                                                                            marginTop: '3px',
                                                                            marginBottom: '3px',
                                                                        }} strong>{'漏洞概述'}</Text>
                                                                    </Row>
                                                                    <Row>
                                                                        <Text style={{
                                                                            marginTop: '3px',
                                                                            marginBottom: '3px',
                                                                        }}>
                                                                            {'漏洞概述:'} <a href={pocResult.url}
                                                                                             target="_blank"
                                                                                             style={{
                                                                                                 color: '#4086FF',
                                                                                                 textDecoration: 'none',
                                                                                             }}>
                                                                            {pocResult.url}
                                                                        </a>
                                                                        </Text>
                                                                    </Row>
                                                                </Col>
                                                            </Row>
                                                        </Card>
                                                    </React.Fragment>
                                                );
                                            })}
                                        </Card>
                                    </Row>
                                );
                            })}
                        </ul>
                    ) : (<div>
                            <Alert
                                message="未获取到该主机漏洞数据"
                                description=""
                                type="warning"
                                showIcon
                                icon={<ExclamationCircleOutlined style={{ color: '#ffcc00' }} />}
                                style={{ marginBottom: '20px' }} />
                        </div>
                    )}
                </div>
            );
        } else {
            return (
                <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center' }}>
                    <LoadingOutlined style={{ fontSize: '3em' }} />
                    <p>未扫描到漏洞</p>
                </div>
            );
        }
    };

    render() {
        const { isSidebarOpen, toggleSidebar } = this.props;
        return (
            <DataContext.Consumer>
                {(context: DataContextType | undefined) => {
                    if (!context) {
                        return (
                            <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center' }}>
                                <LoadingOutlined style={{ fontSize: '3em' }} />
                            </div>); // 或者其他的加载状态显示
                    }
                    // 从 context 中解构出 vuln的详细信息，这部分信息是通过特殊的
                    const { vulnOriginData } = context;

                    // const filteredTransformedData = transformedData.filter(item => item.ip === '127.0.0.1')[0];
                    // const data = {
                    //     '漏洞名称': '漏洞id'+filteredTransformedData.id+'(Sudo 本地权限提升漏洞)',
                    //     '漏洞编号': filteredTransformedData.vul_detection_exp_result_bug_exp,
                    //     '漏洞类型': '漏洞finger_id'+filteredTransformedData.vul_detection_finger_result_id+'(文件访問前链接解析不正确)',
                    //     '风险级别': '漏洞poc_id'+filteredTransformedData.vul_detection_poc_result_id+'(高危)',
                    //     '是否有exp': '是',};
                    //     const data1={
                    //         '漏洞poc': filteredTransformedData.vul_detection_poc_result_url+'(本地非特权用户可以通过将临时文件替换为任意文件目标的符号链接来获取文件所有权和提升特权。这会影响许可模式下的SELinux RBAC支持。没有SELinux的机器不容易受到攻击。)',
                    //         }
                    return (
                        <div className={isSidebarOpen ? 'sidebar open' : 'sidebar'} style={{ fontFamily: '宋体, sans-serif', fontWeight: 'bold' }}>
                            {/* <DisplayFilteredData
                             filterData={vulnFilteredData}
                            /> */}
                            <Row style={{ width: '100%' }}>
                                <Col md={24} style={{ borderTop: '5px solid #4086FF' }}>
                                    {this.renderVulnDetail(vulnOriginData)}
                                </Col>
                            </Row>
                            {/*{this.renderModal()}*/}
                        </div>
                    );
                }}
            </DataContext.Consumer>
        );


    }
}

export default VulnerabilityDetailsSidebar;